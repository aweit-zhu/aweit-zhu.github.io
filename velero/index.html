<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="weizhi.zhu" /><link rel="canonical" href="https://aweit-zhu.github.io/velero/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Velero - My Docs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Velero";
        var mkdocs_page_input_path = "velero.md";
        var mkdocs_page_url = "/velero/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> My Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../microk8s/">Microk8s</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../drone/">Drone</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sonarqube/">SonarQube</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../practicek8s/">Kubernetes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../docker/">Docker</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../dapr/">Dapr</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../traefik/">Treafik</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Velero</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">My Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>Velero</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p><img src="../image-22.png" alt="drawing" width="200"/></p>
<p>參考資料：
- Velero 初探與實踐 <a href="https://kaichu.io/posts/velero-research-practice/">https://kaichu.io/posts/velero-research-practice/</a>
- 官網 <a href="https://velero.io/docs/v1.11/how-velero-works/">https://velero.io/docs/v1.11/how-velero-works/</a>
- 使用 Velero 備份還原 Kubernetes 集羣 <a href="https://www.readfog.com/a/1647215683490123776">https://www.readfog.com/a/1647215683490123776</a>
- Quick start evaluation install with Minio <a href="https://velero.io/docs/main/contributions/minio">https://velero.io/docs/main/contributions/minio</a></p>
<h3 id="_1">運作方式</h3>
<p><img alt="Alt text" src="../image-23.png" /></p>
<ol>
<li>Velero 的基本操作就是 CLI 會去操作 Kubernetes API 建立 Backup 物件</li>
<li>BackupController 偵測到新的 Backup 物件並檢查</li>
<li>檢查通過後就會操作 Kubernetes API Server 進行資料的備份</li>
<li>BackupController 就會透過 Plugin 會操作對應用 Object Storage Service 上傳檔案</li>
<li>如果 Provider 支援原生的快照操作, Plugin 就可以透過 API 備分永久磁碟區</li>
</ol>
<h3 id="_2">安裝</h3>
<p>下載及解壓縮</p>
<pre><code>
wget https://github.com/vmware-tanzu/velero/releases/download/v1.11.0/velero-v1.11.0-linux-amd64.tar.gz

tar -zxvf velero-v1.11.0-linux-amd64.tar.gz &amp;&amp; cd velero-v1.11.0-linux-amd64

</code></pre>
<h3 id="minio">安裝MINIO</h3>
<p>要將 examples/minio/00-minio-deployment.yaml 修改成以下</p>
<pre><code># Copyright 2017 the Velero contributors.
#
# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
apiVersion: v1
kind: Namespace
metadata:
  name: velero

---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: velero
  name: minio
  labels:
    component: minio
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      component: minio
  template:
    metadata:
      labels:
        component: minio
    spec:
      volumes:
      - name: storage
        emptyDir: {}
      - name: config
        emptyDir: {}
      containers:
      - name: minio
        image: minio/minio:latest
        imagePullPolicy: IfNotPresent
        args:
        - server
        - /storage
        - --config-dir=/config
        - --console-address=:9001
        env:
        - name: MINIO_ACCESS_KEY
          value: &quot;minio&quot;
        - name: MINIO_SECRET_KEY
          value: &quot;minio123&quot;
        ports:
        - containerPort: 9000
        - containerPort: 9001
        volumeMounts:
        - name: storage
          mountPath: &quot;/storage&quot;
        - name: config
          mountPath: &quot;/config&quot;

---
apiVersion: v1
kind: Service
metadata:
  namespace: velero
  name: minio
  labels:
    component: minio
spec:
  type: NodePort
  ports:
    - name: api
      port: 9000
      targetPort: 9000
    - name: console
      port: 9001
      targetPort: 9001
  selector:
    component: minio

---
apiVersion: batch/v1
kind: Job
metadata:
  namespace: velero
  name: minio-setup
  labels:
    component: minio
spec:
  template:
    metadata:
      name: minio-setup
    spec:
      restartPolicy: OnFailure
      volumes:
      - name: config
        emptyDir: {}
      containers:
      - name: mc
        image: minio/mc:latest
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - &quot;mc --config-dir=/config config host add velero http://minio:9000 minio minio123 &amp;&amp; mc --config-dir=/config mb -p velero/velero&quot;
        volumeMounts:
        - name: config
          mountPath: &quot;/config&quot;

</code></pre>
<p>開啟 kubrnetes dashboard 看 velero minio 是哪個 Port，並開啟瀏覽器</p>
<p><img alt="Alt text" src="../image-25.png" /></p>
<p>http://192.168.0.17:32729/browser</p>
<p>帳號/密碼：minio/minio123</p>
<p><img alt="Alt text" src="../image-24.png" /></p>
<p>P.S.：</p>
<p>當然如果需要在不同 Kubernetes 和存儲池集羣備份與恢復數據，需要將 minio 服務端安裝在 Kubernetes 集羣外，保證在集羣發生災難性故障時，不會對備份數據產生影響，可以通過二進制的方式進行安裝。</p>
<p>(略) 請參考 <a href="https://www.readfog.com/a/1647215683490123776">https://www.readfog.com/a/1647215683490123776</a> 安裝 MINIO</p>
<h3 id="velero">安裝 velero 服務端</h3>
<p>nano credentials-velero</p>
<pre><code># 秘钥文件credentials-velero
[default]
aws_access_key_id = minio
aws_secret_access_key = minio123
</code></pre>
<p>velero install</p>
<pre><code>velero install \
--provider aws \
--bucket velero \
--plugins velero/velero-plugin-for-aws:latest \
--secret-file ./credentials-velero \
--use-volume-snapshots=false \
--backup-location-config region=minio,s3ForcePathStyle=&quot;true&quot;,s3Url=http://192.168.0.17:31883
</code></pre>
<p>PS：s3Url=http://192.168.0.17:31883 PROT 從哪裡取得？</p>
<p>minio.velero:30050 TCP  --&gt; MiniO 的 URL</p>
<p><img alt="Alt text" src="../image-26.png" /></p>
<p>minio.velero:31883 TCP  --&gt; MiniO 的 Dashboard URL</p>
<p>http://192.168.0.17:30050/</p>
<p><img alt="Alt text" src="../image-27.png" /></p>
<h3 id="back-up">Back up</h3>
<p>先建立一個 Namespace / Development / Service</p>
<pre><code>kubectl apply -f examples/nginx-app/base.yaml
</code></pre>
<p>Create a backup for any object that matches the app=nginx label selector:</p>
<pre><code>velero backup create nginx-backup --selector app=nginx
</code></pre>
<p><img alt="Alt text" src="../image-28.png" /></p>
<p>Run <code>velero backup describe nginx-backup</code> or <code>velero backup logs nginx-backup</code> for more details.</p>
<p><img alt="Alt text" src="../image-29.png" /></p>
<p>這時候去看 MiniO 的 Dashboard，會看到備份的檔案在這。</p>
<p><img alt="Alt text" src="../image-30.png" /></p>
<p>Simulate a disaster <code>kubectl delete namespace nginx-example</code>
To check that the nginx deployment and service are gone, run:</p>
<pre><code>kubectl get deployments --namespace=nginx-example
kubectl get services --namespace=nginx-example
kubectl get namespace/nginx-example
</code></pre>
<h3 id="restore">Restore</h3>
<pre><code>velero restore create --from-backup nginx-backup
</code></pre>
<p>Restore request "nginx-backup-20230710100823" submitted successfully.
Run <code>velero restore describe nginx-backup-20230710100823</code> or <code>velero restore logs nginx-backup-20230710100823</code> for more details.</p>
<pre><code># 看進度
velero restore get
</code></pre>
<p><img alt="Alt text" src="../image-31.png" /></p>
<p>nginx-example 就回來了~</p>
<p><img alt="Alt text" src="../image-32.png" /></p>
<h3 id="clean-up">Clean up</h3>
<p>velero backup delete BACKUP_NAME</p>
<p>velero uninstall --&gt; 全部移除</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../traefik/" class="btn btn-neutral float-left" title="Treafik"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../traefik/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
